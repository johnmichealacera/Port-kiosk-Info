<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socorro Feeder Port - Kiosk Display</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Theme Variables */
        body.windows-glass {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary-color: #0067c0;
            --secondary-color: #8a8886;
            --accent-color: #0078d4;
            --text-primary: #ffffff;
            --text-secondary: #d2d0ce;
            --success-color: #107c10;
            --warning-color: #ffb900;
            --danger-color: #d13438;
            --card-bg: rgba(32, 32, 32, 0.6);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Kiosk Container */
        .kiosk-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        /* Header */
        .kiosk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo-display {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #kiosk-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--card-bg);
            padding: 4px;
        }

        #kiosk-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .next-departure {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary-color);
            border-radius: 8px;
        }

        .next-departure .label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .next-departure .time {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .datetime-info {
            text-align: right;
        }

        .current-date {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .current-time {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
            font-size: 14px;
        }

        /* Main Content */
        .kiosk-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Schedules Panel */
        .schedules-panel {
            flex: 3;
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid var(--glass-border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .panel-header h2 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .schedule-count {
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
            font-size: 14px;
        }

        .schedule-count span {
            font-weight: 600;
            color: var(--accent-color);
        }

        /* Schedules Grid */
        .schedules-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            animation: gridFadeIn 0.5s ease;
        }

        @keyframes gridFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .schedule-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            opacity: 1;
        }

        .schedule-card.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .schedule-card.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .vessel-time {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .vessel-name {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .vessel-destination {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vessel-destination i {
            color: var(--accent-color);
        }

        .schedule-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ontime {
            background: var(--success-color);
        }

        .status-boarding {
            background: #0078d4;
            animation: pulse 2s infinite;
        }

        .status-lastcalled {
            background: var(--warning-color);
            animation: blink 1s infinite;
        }

        .status-departed {
            background: #666;
        }

        .status-delayed {
            background: #ff8c00;
            animation: pulse 1.5s infinite;
        }

        .status-cancelled {
            background: var(--danger-color);
            text-decoration: line-through;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(0, 120, 212, 0);
            }
        }

        .schedule-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--glass-border);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 500;
        }

        /* Media Panel - Simplified */
        .media-panel {
            flex: 2;
            padding: 24px;
            background: rgba(25, 25, 25, 0.8);
            display: flex;
            flex-direction: column;
        }

        .panel-header h2 {
            font-size: 22px;
            font-weight: 600;
        }

        .video-container {
            flex: 1;
            margin-bottom: 20px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #kiosk-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .playlist-info {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid var(--glass-border);
            text-align: center;
        }

        .playlist-info h3 {
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        #now-playing {
            color: var(--accent-color);
            font-weight: 500;
        }

        .playlist-progress {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Admin Sync Status */
        .sync-status-display {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: var(--success-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            justify-content: center;
            margin-top: 8px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: pulseDot 2s infinite;
        }

        @keyframes pulseDot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Footer */
        .kiosk-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 32px;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
        }

        .footer-info {
            display: flex;
            gap: 32px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .info-item i {
            color: var(--accent-color);
        }

        /* Fade Effect Animation */
        @keyframes scheduleFade {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            50% {
                opacity: 0.3;
                transform: translateY(-5px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .schedule-card.fade-effect {
            animation: scheduleFade 1s ease;
        }

        /* Responsive Design for Kiosk */
        @media (max-width: 1200px) {
            .schedules-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kiosk-main {
                flex-direction: column;
            }

            .schedules-panel {
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                max-height: 50vh;
            }

            .kiosk-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .header-left,
            .header-right {
                width: 100%;
                justify-content: center;
            }

            .footer-info {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>

<body class="windows-glass">
    <div class="kiosk-container">
        <!-- Header with Time, Date, Weather -->
        <header class="kiosk-header">
            <div class="header-left">
                <div class="logo-display">
                    <img id="kiosk-logo" src="" alt="Port Logo">
                    <h1 id="kiosk-title">Socorro Feeder Port</h1>
                </div>
                <div class="next-departure">
                    <span class="label">Next Departure:</span>
                    <span id="next-departure-time" class="time">--:-- --</span>
                </div>
            </div>

            <div class="header-right">
                <div class="datetime-info">
                    <div class="current-date" id="current-date">Monday, January 1, 2024</div>
                    <div class="current-time" id="current-time">00:00 AM</div>
                </div>
                <div class="weather-info" id="weather-info">
                    <i class="fas fa-sun"></i>
                    <span>Loading weather...</span>
                </div>
            </div>
        </header>

        <!-- Main Content - Split Screen -->
        <main class="kiosk-main">
            <!-- Left Panel - Schedules -->
            <section class="schedules-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-ship"></i> Today's Departures</h2>
                    <div class="schedule-count">
                        <span id="total-schedules">0</span> Vessels Scheduled
                    </div>
                </div>

                <div class="schedules-grid" id="schedules-grid">
                    <!-- Schedules will be populated in two columns -->
                </div>
            </section>

            <!-- Right Panel - Media Player -->
            <section class="media-panel">
                <div class="panel-header">
                    <h2>Announcements & Information</h2>
                </div>

                <div class="video-container">
                    <video id="kiosk-video" autoplay muted playsinline>
                        Your browser does not support the video tag.
                    </video>
                    <div class="playlist-info">
                        <h3>Now Playing: <span id="now-playing">Waiting for content...</span></h3>
                        <div class="playlist-progress">
                            <span id="playlist-position">0</span> of <span id="playlist-total">0</span> videos loaded
                        </div>
                        <div class="sync-status-display">
                            <div class="sync-indicator" id="sync-indicator">
                                <div class="sync-dot"></div>
                                <span>Connected to Admin</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="kiosk-footer">
            <div class="footer-info">
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <span>Port Office: 123-456-7890</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="system-message">System is operating normally</span>
                </div>
            </div>
            <div class="sync-indicator">
                <div class="sync-dot"></div>
                <span>Live Updates Active</span>
            </div>
        </footer>
    </div>

    <script>
        // Shared Passenger System Class
        class PassengerSystem {
            constructor() {
                this.STORAGE_KEY = 'socorro_port_data';
                this.CHANGE_EVENT = 'dataChanged';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.STORAGE_KEY)) {
                    const defaultData = {
                        schedules: [],
                        systemName: "Socorro Feeder Port",
                        logo: "",
                        mediaPlaylist: [
                            {
                                id: this.generateId(),
                                title: "Welcome to Socorro Feeder Port",
                                source: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
                                type: "url"
                            }
                        ],
                        fadeInterval: 5,
                        boardingTime: 30,
                        lastCallTime: 5,
                        theme: 'windows-glass',
                        // Video control state for kiosk sync
                        videoControl: {
                            currentVideoIndex: 0,
                            isPlaying: true,
                            isLooping: false,
                            volume: 80,
                            lastUpdated: Date.now(),
                            syncRequired: true
                        },
                        playerState: {
                            status: 'stopped',
                            currentTime: 0,
                            duration: 0
                        }
                    };
                    this.saveData(defaultData);
                }
            }

            getData() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : null;
            }

            saveData(data) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                this.triggerChange();
            }

            triggerChange() {
                const event = new CustomEvent(this.CHANGE_EVENT, {
                    detail: { timestamp: Date.now() }
                });
                window.dispatchEvent(event);
                localStorage.setItem('last_update', Date.now());
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            getCurrentDateTime() {
                const now = new Date();
                return {
                    date: now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    time: now.toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                };
            }

            formatTime24to12(time24) {
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12.toString().padStart(2, '0')}:${minutes} ${ampm}`;
            }

            formatTime12to24(time12) {
                const [time, period] = time12.split(' ');
                const [hours, minutes] = time.split(':');
                let hour = parseInt(hours);
                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;
                return `${hour.toString().padStart(2, '0')}:${minutes}`;
            }

            getDayOfWeek() {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[new Date().getDay()];
            }

            async getWeather() {
                const conditions = ['â˜€ï¸ Sunny', 'â›… Partly Cloudy', 'â˜ï¸ Cloudy', 'ðŸŒ§ï¸ Rainy', 'â›ˆï¸ Stormy', 'ðŸŒ¦ï¸ Showers'];
                const icons = ['fa-sun', 'fa-cloud-sun', 'fa-cloud', 'fa-cloud-rain', 'fa-bolt', 'fa-cloud-showers-heavy'];
                const index = Math.floor(Math.random() * conditions.length);
                return {
                    temp: Math.floor(Math.random() * 20) + 20,
                    condition: conditions[index],
                    icon: icons[index],
                    humidity: Math.floor(Math.random() * 40) + 40
                };
            }

            sortSchedules(schedules) {
                const now = new Date();
                const currentHour = now.getHours();
                const isPM = currentHour >= 12;

                return schedules.sort((a, b) => {
                    const timeA = this.parseTime(a.time.split(' - ')[0]);
                    const timeB = this.parseTime(b.time.split(' - ')[0]);

                    if (isPM) {
                        const aIsPM = timeA.hour >= 12;
                        const bIsPM = timeB.hour >= 12;

                        if (aIsPM && !bIsPM) return -1;
                        if (!aIsPM && bIsPM) return 1;
                    }

                    if (timeA.hour !== timeB.hour) {
                        return timeA.hour - timeB.hour;
                    }
                    return timeA.minute - timeB.minute;
                });
            }

            parseTime(timeStr) {
                const [time, period] = timeStr.split(' ');
                const [hours, minutes] = time.split(':');
                let hour = parseInt(hours);

                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;

                return { hour, minute: parseInt(minutes) };
            }

            getTimeDifferenceInMinutes(scheduleTimeStr) {
                const now = new Date();
                const [time, period] = scheduleTimeStr.split(' ');
                const [hours, minutes] = time.split(':');

                let hour = parseInt(hours);
                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;

                const scheduleTime = new Date();
                scheduleTime.setHours(hour, parseInt(minutes), 0, 0);

                return (scheduleTime - now) / (1000 * 60);
            }
        }

        // Create global instance
        window.passengerSystem = new PassengerSystem();

        // Kiosk functionality
        document.addEventListener('DOMContentLoaded', function () {
            const system = window.passengerSystem;
            let schedules = [];
            let mediaPlaylist = [];
            let videoControl = null;
            let videoPlayer = null;
            let currentVideoIndex = 0;
            let isPlaying = false;
            let isLooping = false;
            let fadeInterval = 5;
            let fadeTimer = null;
            let updateTimer = null;
            let syncInterval = null;
            let lastSyncTime = 0;

            // Initialize kiosk
            initKiosk();

            function initKiosk() {
                videoPlayer = document.getElementById('kiosk-video');
                loadSystemConfig();
                loadSchedules();
                loadMediaPlaylist();
                setupVideoPlayer();
                updateDateTime();
                updateWeather();
                startAutoUpdates();
                startFadeEffect();
                startSyncMonitoring();

                // Auto-enter fullscreen/kiosk mode
                setTimeout(enterKioskMode, 1000);
            }

            // Load system configuration
            function loadSystemConfig() {
                const data = system.getData();

                // Update display
                document.getElementById('kiosk-title').textContent = data.systemName || "Socorro Feeder Port";
                if (data.logo) {
                    document.getElementById('kiosk-logo').src = data.logo;
                } else {
                    document.getElementById('kiosk-logo').style.display = 'none';
                }

                // Load settings
                fadeInterval = data.fadeInterval || 5;

                // Update system message
                updateSystemMessage();
            }

            // Load and display schedules
            function loadSchedules() {
                const data = system.getData();
                schedules = data.schedules || [];

                // Filter schedules for today
                const today = system.getDayOfWeek();
                const todaySchedules = schedules.filter(schedule =>
                    schedule.days.includes(today)
                );

                // Sort schedules
                const sortedSchedules = system.sortSchedules(todaySchedules);

                // Update count
                document.getElementById('total-schedules').textContent = sortedSchedules.length;

                // Update next departure
                updateNextDeparture(sortedSchedules);

                // Display in grid
                displaySchedulesGrid(sortedSchedules);
            }

            function displaySchedulesGrid(schedules) {
                const grid = document.getElementById('schedules-grid');
                grid.innerHTML = '';

                schedules.forEach((schedule, index) => {
                    const card = createScheduleCard(schedule, index);
                    grid.appendChild(card);
                });
            }

            function createScheduleCard(schedule, index) {
                const card = document.createElement('div');
                card.className = 'schedule-card';
                card.dataset.id = schedule.id;
                card.dataset.index = index;

                // Calculate times
                const [departure, arrival] = schedule.time.split(' - ');

                // Determine if boarding or last call based on current time
                const status = calculateRealTimeStatus(schedule, departure);

                // Create status badge
                const statusClass = `status-${status.toLowerCase().replace(' ', '')}`;
                const statusText = status === 'Ontime' ? schedule.status : status;

                card.innerHTML = `
                    <div class="schedule-header">
                        <div class="vessel-info">
                            <div class="vessel-time">${departure}</div>
                            <div class="vessel-name">${schedule.vessel}</div>
                        </div>
                        <div class="schedule-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="vessel-destination">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${schedule.destination}</span>
                    </div>
                    <div class="schedule-details">
                        <div class="detail-item">
                            <span class="detail-label">Arrival</span>
                            <span class="detail-value">${arrival}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">${schedule.status}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Days</span>
                            <span class="detail-value">${schedule.days.join(', ')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Vessel</span>
                            <span class="detail-value">${schedule.vessel}</span>
                        </div>
                    </div>
                `;

                // Add cancelled strikethrough
                if (schedule.status === 'Cancelled') {
                    card.style.opacity = '0.6';
                    card.querySelectorAll('*').forEach(el => {
                        el.style.textDecoration = 'line-through';
                    });
                }

                return card;
            }

            function calculateRealTimeStatus(schedule, departureTime) {
                const diffMinutes = system.getTimeDifferenceInMinutes(departureTime);

                // Get boarding time from settings
                const data = system.getData();
                const boardingTime = data.boardingTime || 30;
                const lastCallTime = data.lastCallTime || 5;

                if (diffMinutes <= 0 && diffMinutes > -lastCallTime) {
                    return 'Last Called';
                } else if (diffMinutes > 0 && diffMinutes <= boardingTime) {
                    return 'Boarding';
                } else if (diffMinutes <= -lastCallTime) {
                    return 'Departed';
                }

                return schedule.status;
            }

            function updateNextDeparture(schedules) {
                const now = new Date();
                let nextSchedule = null;

                for (const schedule of schedules) {
                    if (schedule.status === 'Cancelled') continue;

                    const [departure] = schedule.time.split(' - ');
                    const diffMinutes = system.getTimeDifferenceInMinutes(departure);

                    if (diffMinutes > 0) {
                        if (!nextSchedule || diffMinutes < system.getTimeDifferenceInMinutes(nextSchedule.time.split(' - ')[0])) {
                            nextSchedule = schedule;
                        }
                    }
                }

                if (nextSchedule) {
                    const [departure] = nextSchedule.time.split(' - ');
                    document.getElementById('next-departure-time').textContent = departure;
                } else {
                    document.getElementById('next-departure-time').textContent = '--:-- --';
                }
            }

            // Media Playlist - Load from shared data
            function loadMediaPlaylist() {
                const data = system.getData();
                mediaPlaylist = data.mediaPlaylist || [];
                videoControl = data.videoControl || null;

                // Update playlist info
                document.getElementById('playlist-total').textContent = mediaPlaylist.length;

                if (mediaPlaylist.length === 0) {
                    document.getElementById('now-playing').textContent = 'No videos in playlist';
                    document.getElementById('playlist-position').textContent = '0';
                    return;
                }

                // Check if we have video control state from admin
                if (videoControl && videoControl.lastUpdated > lastSyncTime) {
                    applyVideoControl();
                } else if (mediaPlaylist.length > 0) {
                    // No control from admin, start playing
                    playVideo(currentVideoIndex);
                }
            }

            function applyVideoControl() {
                if (!videoControl) return;

                // Update local state from control
                const nextIndex = videoControl.currentVideoIndex || 0;
                const shouldPlay = videoControl.isPlaying || false;
                isLooping = videoControl.isLooping || false;

                // Ensure index is within bounds
                if (mediaPlaylist.length === 0) return;

                if (nextIndex >= mediaPlaylist.length) {
                    currentVideoIndex = 0;
                } else {
                    currentVideoIndex = nextIndex;
                }

                // Apply volume if set
                if (videoControl.volume !== undefined) {
                    videoPlayer.volume = videoControl.volume / 100;
                }

                // Play the video
                playVideo(currentVideoIndex);

                // Apply play/pause state
                if (shouldPlay) {
                    videoPlayer.play().then(() => {
                        isPlaying = true;
                    }).catch(e => {
                        console.log('Auto-play prevented, waiting for user interaction');
                        isPlaying = false;
                    });
                } else {
                    videoPlayer.pause();
                    isPlaying = false;
                }

                // Apply loop state
                videoPlayer.loop = isLooping;

                // Update display
                updatePlaylistInfo();

                // Mark as synced
                lastSyncTime = videoControl.lastUpdated || Date.now();
            }


            function playVideo(index) {
                if (mediaPlaylist.length === 0) {
                    document.getElementById('now-playing').textContent = 'No videos available';
                    return;
                }

                // Ensure index is valid
                if (index < 0 || index >= mediaPlaylist.length) {
                    index = 0;
                }

                currentVideoIndex = index;
                const video = mediaPlaylist[currentVideoIndex];

                try {
                    videoPlayer.src = video.source;
                    videoPlayer.load();

                    // Update display
                    document.getElementById('now-playing').textContent = video.title;
                    document.getElementById('playlist-position').textContent = currentVideoIndex + 1;

                    // Try to play
                    if (isPlaying) {
                        videoPlayer.play().catch(e => {
                            console.log('Video play failed, will retry:', e);
                        });
                    }

                } catch (error) {
                    console.error('Error setting video source:', error);
                    // Try next video after 3 seconds
                    setTimeout(() => {
                        playNextVideo();
                    }, 3000);
                }
            }

            function playNextVideo() {
                if (mediaPlaylist.length === 0) return;

                currentVideoIndex = (currentVideoIndex + 1) % mediaPlaylist.length;
                playVideo(currentVideoIndex);
            }

            function updatePlaylistInfo() {
                if (mediaPlaylist.length > 0 && currentVideoIndex < mediaPlaylist.length) {
                    const video = mediaPlaylist[currentVideoIndex];
                    document.getElementById('now-playing').textContent = video.title;
                    document.getElementById('playlist-position').textContent = currentVideoIndex + 1;
                }
            }

            function setupVideoPlayer() {
                // Video event listeners
                videoPlayer.addEventListener('ended', () => {
                    if (!isLooping) {
                        playNextVideo();
                    }
                });

                videoPlayer.addEventListener('error', () => {
                    console.log('Video error, trying next video');
                    setTimeout(() => {
                        playNextVideo();
                    }, 3000);
                });

                videoPlayer.addEventListener('loadeddata', () => {
                    console.log('Video loaded successfully');
                });

                videoPlayer.addEventListener('play', () => {
                    isPlaying = true;
                });

                videoPlayer.addEventListener('pause', () => {
                    isPlaying = false;
                });
            }

            // Sync Monitoring
            function startSyncMonitoring() {
                // Check for updates every second
                syncInterval = setInterval(checkForAdminUpdates, 1000);
            }

            function checkForAdminUpdates() {
                const data = system.getData();

                // First, check for playlist changes to ensure we have the media
                const newPlaylist = data.mediaPlaylist || [];
                // Simple check if playlist changed - deep comparison for production would be better
                // but for now length check + first item check is a quick heuristic
                const playlistChanged = JSON.stringify(newPlaylist) !== JSON.stringify(mediaPlaylist);

                if (playlistChanged) {
                    mediaPlaylist = newPlaylist;
                    loadMediaPlaylist();
                    // If playlist changed, we might need to re-validate current video index
                }

                // Check for video control changes
                const newVideoControl = data.videoControl || null;

                // We sync if:
                // 1. We have new control data
                // 2. AND (it's newer than our last sync OR it's explicitly flagged as required)
                if (newVideoControl && (newVideoControl.lastUpdated > lastSyncTime || newVideoControl.syncRequired)) {

                    // If we just synced playlist, give it a moment to settle if needed, 
                    // though since we just loaded it into memory above, it should be fine.

                    videoControl = newVideoControl;
                    applyVideoControl();

                    // Visual feedback for sync
                    const syncIndicator = document.getElementById('sync-indicator');
                    if (syncIndicator) {
                        syncIndicator.style.backgroundColor = '#107c10';
                        setTimeout(() => {
                            syncIndicator.style.backgroundColor = '';
                        }, 500);
                    }
                }
            }

            // DateTime and Weather
            function updateDateTime() {
                const { date, time } = system.getCurrentDateTime();
                document.getElementById('current-date').textContent = date;
                document.getElementById('current-time').textContent = time;
            }

            async function updateWeather() {
                try {
                    const weather = await system.getWeather();
                    const weatherElement = document.getElementById('weather-info');

                    weatherElement.innerHTML = `
                        <i class="fas ${weather.icon}"></i>
                        <span>${weather.temp}Â°C | ${weather.condition}</span>
                    `;
                } catch (error) {
                    console.error('Error updating weather:', error);
                    document.getElementById('weather-info').innerHTML = `
                        <i class="fas fa-cloud"></i>
                        <span>Weather unavailable</span>
                    `;
                }
            }

            function updateSystemMessage() {
                const messages = [
                    "System is operating normally",
                    "Welcome to Socorro Feeder Port",
                    "Have a pleasant journey",
                    "Safety is our priority",
                    "Thank you for choosing our service",
                    "Please check departure times regularly",
                    "Board 30 minutes before departure",
                    "Follow crew instructions",
                    "Keep your belongings safe",
                    "Enjoy your voyage"
                ];

                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                document.getElementById('system-message').textContent = randomMessage;
            }

            // Fade Effect
            function startFadeEffect() {
                // Clear any existing timer
                if (fadeTimer) clearInterval(fadeTimer);

                const fadeMinutes = fadeInterval * 60 * 1000; // Convert to milliseconds

                fadeTimer = setInterval(() => {
                    applyFadeEffect();
                }, fadeMinutes);

                // Also apply immediately
                setTimeout(applyFadeEffect, 1000);
            }

            function applyFadeEffect() {
                const cards = document.querySelectorAll('.schedule-card');
                if (cards.length === 0) return;

                // Add fade class to first card
                const firstCard = cards[0];
                firstCard.classList.add('fade-effect');

                // After animation, move to end
                setTimeout(() => {
                    firstCard.classList.remove('fade-effect');

                    // Get the schedule ID and reorder in data
                    const scheduleId = firstCard.dataset.id;
                    const data = system.getData();
                    const scheduleIndex = data.schedules.findIndex(s => s.id === scheduleId);

                    if (scheduleIndex !== -1) {
                        // Move schedule to end
                        const [schedule] = data.schedules.splice(scheduleIndex, 1);
                        data.schedules.push(schedule);
                        system.saveData(data);

                        // Reload display
                        loadSchedules();
                    }
                }, 1000); // Match CSS animation duration
            }

            // Auto Updates
            function startAutoUpdates() {
                // Clear any existing timers
                if (updateTimer) clearInterval(updateTimer);

                // Update time every second
                setInterval(updateDateTime, 1000);

                // Update schedules and weather every 30 seconds
                updateTimer = setInterval(() => {
                    loadSchedules();
                    updateWeather();
                    updateSystemMessage();
                }, 30000);
            }

            // Real-time Sync with storage events
            window.addEventListener('storage', function (e) {
                if (e.key === 'last_update' || e.key === 'socorro_port_data') {
                    // Data changed, reload everything
                    loadSystemConfig();
                    loadSchedules();
                    loadMediaPlaylist();

                    // Visual feedback
                    const syncDot = document.querySelector('.sync-dot');
                    if (syncDot) {
                        syncDot.style.animation = 'none';
                        setTimeout(() => {
                            syncDot.style.animation = 'pulseDot 2s infinite';
                        }, 10);
                    }
                }
            });

            // Also listen for custom events
            window.addEventListener(system.CHANGE_EVENT, function () {
                loadSystemConfig();
                loadSchedules();
                loadMediaPlaylist();
            });

            // Fullscreen and kiosk mode
            function enterKioskMode() {
                // Request fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) { // Firefox
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) { // Chrome, Safari & Opera
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { // IE/Edge
                    elem.msRequestFullscreen();
                }

                // Prevent right-click context menu
                document.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    return false;
                });

                // Prevent keyboard shortcuts that could exit kiosk mode
                document.addEventListener('keydown', function (e) {
                    // Allow F11 for fullscreen toggle
                    if (e.key === 'F11') {
                        return;
                    }

                    // Block common exit shortcuts
                    if (e.ctrlKey || e.altKey || e.metaKey) {
                        e.preventDefault();
                        return false;
                    }
                });

                // Prevent dragging
                document.addEventListener('dragstart', function (e) {
                    e.preventDefault();
                    return false;
                });

                // Prevent text selection
                document.addEventListener('selectstart', function (e) {
                    e.preventDefault();
                    return false;
                });
            }

            // Handle fullscreen change
            document.addEventListener('fullscreenchange', function () {
                if (!document.fullscreenElement) {
                    // Automatically re-enter fullscreen if exited
                    setTimeout(enterKioskMode, 1000);
                }
            });

            // Initialize when page loads
            window.addEventListener('load', initKiosk);
        });
    </script>
</body>

</html>